<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Angel Luis Torres (250)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Angel Luis Torres";
  const OPERATOR_CODE = "250";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_250";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Antonio Ramos (243)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Antonio Ramos";
  const OPERATOR_CODE = "243";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_243";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Turno - LÃ­der</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<style>
  body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
  .action-button{ transition:.12s }
  .logo { width:40px; height:40px }
  .section-title { font-weight:600; color:#1F4E79 } /* azul corporativo */
  .submit-button { background:#1F4E79; color:white }
  .submit-button:hover { background:#163955 }
</style>
</head>
<body class="p-4">
<div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
  <header class="mb-4 flex items-center">
    <img src="images/logo.png" alt="Logo" width="40" height="40" class="inline-block mr-2">
    <h1 class="text-2xl font-bold">Registro de Turno - LÃ­der</h1>
  </header>

  <div>Usuario: <span id="operator-name">Antonio Montes (120)</span></div>

  <div id="form-container"></div>

  <div class="mt-4">
    <button onclick="submitReport()" class="submit-button px-4 py-2 rounded font-semibold">Enviar Reporte</button>
  </div>
</div>

<script>
const OPERATOR_NAME = "Antonio Montes";
const OPERATOR_CODE = "120";
let userId = "user_120";

const formContainer = document.getElementById('form-container');

// FunciÃ³n para crear una fila de producciÃ³n/reparaciÃ³n con Palets y Tapas fijos
function createRow(section){
  const div = document.createElement('div');
  div.className = "grid grid-cols-1 md:grid-cols-4 gap-4 mt-2 row-entry";

  div.innerHTML = `
    <select class="${section}-modelo w-full border rounded p-2">
      <option>CHEP 1210</option>
      <option>CHEP 1208</option>
      <option>IPP 1208</option>
      <option>IPP 1210</option>
      <option>PR80</option>
      <option>UK 100</option>
      <option>AZ 80</option>
      <option>AZ 100</option>
      <option>EUR-UIC</option>
      <option>OTROS</option>
    </select>
    <input type="number" class="${section}-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="${section}-tapas w-full border rounded p-2" placeholder="Tapas" min="0">
    <button type="button" class="px-2 py-1 bg-gray-200 rounded" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  return div;
}

formContainer.innerHTML = `
  <h2 class="section-title mt-4">ProducciÃ³n</h2>
  <div id="produccion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-green-600 text-white rounded" onclick="addRow('produccion')">AÃ±adir otra producciÃ³n</button>

  <h2 class="section-title mt-4">ReparaciÃ³n</h2>
  <div id="reparacion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-orange-600 text-white rounded" onclick="addRow('reparacion')">AÃ±adir otra reparaciÃ³n</button>

  <h2 class="section-title mt-4">Mermas</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <input type="number" class="mermas-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="mermas-maderas w-full border rounded p-2" placeholder="Maderas" min="0">
    <input type="number" class="mermas-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="mermas-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="mermas-alto w-full border rounded p-2" placeholder="Alto">
  </div>

  <h2 class="section-title mt-4">RecuperaciÃ³n</h2>
  <select id="recuperacion-tipo" class="w-full border rounded p-2 mb-2">
    <option value="retestado">Retestado</option>
    <option value="otros">Otros</option>
  </select>
  <div id="recuperacion-detalles" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
    <input type="number" class="rec-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="rec-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="rec-alto w-full border rounded p-2" placeholder="Alto">
    <input type="number" class="rec-cantidad w-full border rounded p-2" placeholder="Cantidad">
  </div>

  <h2 class="section-title mt-4">Incidencias</h2>
  <textarea class="inc-mantenimiento w-full border rounded p-2 mb-2" rows="3" placeholder="Incidencias mantenimiento"></textarea>
  <textarea class="inc-produccion w-full border rounded p-2" rows="3" placeholder="Incidencias producciÃ³n"></textarea>
`;

addRow('produccion');
addRow('reparacion');

// Funciones
function addRow(section){
  const container = document.getElementById(section+'-container');
  container.appendChild(createRow(section));
}

document.getElementById('recuperacion-tipo').addEventListener('change', ()=>{
  document.getElementById('recuperacion-detalles').style.display = 'grid';
});

async function submitReport(){
  const produccion = Array.from(document.querySelectorAll('#produccion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.produccion-modelo').value,
    palets: parseInt(r.querySelector('.produccion-palets').value||0),
    tapas: parseInt(r.querySelector('.produccion-tapas').value||0)
  }));

  const reparacion = Array.from(document.querySelectorAll('#reparacion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.reparacion-modelo').value,
    palets: parseInt(r.querySelector('.reparacion-palets').value||0),
    tapas: parseInt(r.querySelector('.reparacion-tapas').value||0)
  }));

  const report = {
    lider: OPERATOR_NAME,
    userId,
    produccion,
    reparacion,
    mermas: {
      palets: parseInt(document.querySelector('.mermas-palets').value||0),
      maderas: parseInt(document.querySelector('.mermas-maderas').value||0),
      largo: parseInt(document.querySelector('.mermas-largo').value||0),
      ancho: parseInt(document.querySelector('.mermas-ancho').value||0),
      alto: parseInt(document.querySelector('.mermas-alto').value||0)
    },
    recuperacion: {
      tipo: document.getElementById('recuperacion-tipo').value,
      largo: parseInt(document.querySelector('.rec-largo').value||0),
      ancho: parseInt(document.querySelector('.rec-ancho').value||0),
      alto: parseInt(document.querySelector('.rec-alto').value||0),
      cantidad: parseInt(document.querySelector('.rec-cantidad').value||0)
    },
    incidencias: {
      mantenimiento: document.querySelector('.inc-mantenimiento').value,
      produccion: document.querySelector('.inc-produccion').value
    },
    fecha: new Date().toISOString()
  };

  try{
    const resp = await fetch('/api/reportes', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(report)
    });
    if(resp.ok){
      alert('âœ… Reporte enviado correctamente');
      document.querySelectorAll('input, textarea').forEach(i=>i.value='');
      document.getElementById('produccion-container').innerHTML='';
      document.getElementById('reparacion-container').innerHTML='';
      addRow('produccion');
      addRow('reparacion');
    } else {
      const json = await resp.json();
      alert('Error al enviar: ' + (json.error||''));
    }
  } catch(err){
    console.error(err);
    alert('Error al enviar el reporte');
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Turno - LÃ­der</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<style>
  body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
  .action-button{ transition:.12s }
  .logo { width:40px; height:40px }
  .section-title { font-weight:600; color:#1F4E79 } /* azul corporativo */
  .submit-button { background:#1F4E79; color:white }
  .submit-button:hover { background:#163955 }
</style>
</head>
<body class="p-4">
<div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
  <header class="mb-4 flex items-center">
    <img src="logo.png" alt="Logo" class="logo mr-2">
    <h1 class="text-2xl font-bold">Registro de Turno - LÃ­der</h1>
  </header>

  <div>Usuario: <span id="operator-name"></span></div>

  <div id="form-container"></div>

  <div class="mt-4">
    <button onclick="submitReport()" class="submit-button px-4 py-2 rounded font-semibold">Enviar Reporte</button>
  </div>
</div>

<script>
const OPERATOR_NAME = "";
const OPERATOR_CODE = "";
let userId = crypto.randomUUID();

const formContainer = document.getElementById('form-container');

// FunciÃ³n para crear una fila de producciÃ³n/reparaciÃ³n con Palets y Tapas fijos
function createRow(section){
  const div = document.createElement('div');
  div.className = "grid grid-cols-1 md:grid-cols-4 gap-4 mt-2 row-entry";

  div.innerHTML = `
    <select class="${section}-modelo w-full border rounded p-2">
      <option>CHEP 1210</option>
      <option>CHEP 1208</option>
      <option>IPP 1208</option>
      <option>IPP 1210</option>
      <option>PR80</option>
      <option>UK 100</option>
      <option>AZ 80</option>
      <option>AZ 100</option>
      <option>EUR-UIC</option>
      <option>OTROS</option>
    </select>
    <input type="number" class="${section}-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="${section}-tapas w-full border rounded p-2" placeholder="Tapas" min="0">
    <button type="button" class="px-2 py-1 bg-gray-200 rounded" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  return div;
}

formContainer.innerHTML = `
  <h2 class="section-title mt-4">ProducciÃ³n</h2>
  <div id="produccion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-green-600 text-white rounded" onclick="addRow('produccion')">AÃ±adir otra producciÃ³n</button>

  <h2 class="section-title mt-4">ReparaciÃ³n</h2>
  <div id="reparacion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-orange-600 text-white rounded" onclick="addRow('reparacion')">AÃ±adir otra reparaciÃ³n</button>

  <h2 class="section-title mt-4">Mermas</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <input type="number" class="mermas-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="mermas-maderas w-full border rounded p-2" placeholder="Maderas" min="0">
    <input type="number" class="mermas-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="mermas-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="mermas-alto w-full border rounded p-2" placeholder="Alto">
  </div>

  <h2 class="section-title mt-4">RecuperaciÃ³n</h2>
  <select id="recuperacion-tipo" class="w-full border rounded p-2 mb-2">
    <option value="retestado">Retestado</option>
    <option value="otros">Otros</option>
  </select>
  <div id="recuperacion-detalles" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
    <input type="number" class="rec-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="rec-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="rec-alto w-full border rounded p-2" placeholder="Alto">
    <input type="number" class="rec-cantidad w-full border rounded p-2" placeholder="Cantidad">
  </div>

  <h2 class="section-title mt-4">Incidencias</h2>
  <textarea class="inc-mantenimiento w-full border rounded p-2 mb-2" rows="3" placeholder="Incidencias mantenimiento"></textarea>
  <textarea class="inc-produccion w-full border rounded p-2" rows="3" placeholder="Incidencias producciÃ³n"></textarea>
`;

addRow('produccion');
addRow('reparacion');

// Funciones
function addRow(section){
  const container = document.getElementById(section+'-container');
  container.appendChild(createRow(section));
}

document.getElementById('recuperacion-tipo').addEventListener('change', ()=>{
  document.getElementById('recuperacion-detalles').style.display = 'grid';
});

async function submitReport(){
  const produccion = Array.from(document.querySelectorAll('#produccion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.produccion-modelo').value,
    palets: parseInt(r.querySelector('.produccion-palets').value||0),
    tapas: parseInt(r.querySelector('.produccion-tapas').value||0)
  }));

  const reparacion = Array.from(document.querySelectorAll('#reparacion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.reparacion-modelo').value,
    palets: parseInt(r.querySelector('.reparacion-palets').value||0),
    tapas: parseInt(r.querySelector('.reparacion-tapas').value||0)
  }));

  const report = {
    lider: OPERATOR_NAME,
    userId,
    produccion,
    reparacion,
    mermas: {
      palets: parseInt(document.querySelector('.mermas-palets').value||0),
      maderas: parseInt(document.querySelector('.mermas-maderas').value||0),
      largo: parseInt(document.querySelector('.mermas-largo').value||0),
      ancho: parseInt(document.querySelector('.mermas-ancho').value||0),
      alto: parseInt(document.querySelector('.mermas-alto').value||0)
    },
    recuperacion: {
      tipo: document.getElementById('recuperacion-tipo').value,
      largo: parseInt(document.querySelector('.rec-largo').value||0),
      ancho: parseInt(document.querySelector('.rec-ancho').value||0),
      alto: parseInt(document.querySelector('.rec-alto').value||0),
      cantidad: parseInt(document.querySelector('.rec-cantidad').value||0)
    },
    incidencias: {
      mantenimiento: document.querySelector('.inc-mantenimiento').value,
      produccion: document.querySelector('.inc-produccion').value
    },
    fecha: new Date().toISOString()
  };

  try{
    const resp = await fetch('/api/reportes', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(report)
    });
    if(resp.ok){
      alert('âœ… Reporte enviado correctamente');
      document.querySelectorAll('input, textarea').forEach(i=>i.value='');
      document.getElementById('produccion-container').innerHTML='';
      document.getElementById('reparacion-container').innerHTML='';
      addRow('produccion');
      addRow('reparacion');
    } else {
      const json = await resp.json();
      alert('Error al enviar: ' + (json.error||''));
    }
  } catch(err){
    console.error(err);
    alert('Error al enviar el reporte');
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "__OPERATOR_NAME__";
  const OPERATOR_CODE = "__OPERATOR_CODE__";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = crypto.randomUUID();
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Carlos Javier Rivera (158)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Carlos Javier Rivera";
  const OPERATOR_CODE = "158";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_158";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Eloy QuiÃ±ones (40)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Eloy QuiÃ±ones";
  const OPERATOR_CODE = "40";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_40";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Turno - LÃ­der</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<style>
  body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
  .action-button{ transition:.12s }
  .logo { width:40px; height:40px }
  .section-title { font-weight:600; color:#1F4E79 } /* azul corporativo */
  .submit-button { background:#1F4E79; color:white }
  .submit-button:hover { background:#163955 }
</style>
</head>
<body class="p-4">
<div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
  <header class="mb-4 flex items-center">
    <img src="images/logo.png" alt="Logo" width="40" height="40" class="inline-block mr-2">
    <h1 class="text-2xl font-bold">Registro de Turno - LÃ­der</h1>
  </header>

  <div>Usuario: <span id="operator-name">Francisco Garcia (229)</span></div>

  <div id="form-container"></div>

  <div class="mt-4">
    <button onclick="submitReport()" class="submit-button px-4 py-2 rounded font-semibold">Enviar Reporte</button>
  </div>
</div>

<script>
const OPERATOR_NAME = "Francisco Garcia";
const OPERATOR_CODE = "229";
let userId = "user_229";

const formContainer = document.getElementById('form-container');

// FunciÃ³n para crear una fila de producciÃ³n/reparaciÃ³n con Palets y Tapas fijos
function createRow(section){
  const div = document.createElement('div');
  div.className = "grid grid-cols-1 md:grid-cols-4 gap-4 mt-2 row-entry";

  div.innerHTML = `
    <select class="${section}-modelo w-full border rounded p-2">
      <option>CHEP 1210</option>
      <option>CHEP 1208</option>
      <option>IPP 1208</option>
      <option>IPP 1210</option>
      <option>PR80</option>
      <option>UK 100</option>
      <option>AZ 80</option>
      <option>AZ 100</option>
      <option>EUR-UIC</option>
      <option>OTROS</option>
    </select>
    <input type="number" class="${section}-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="${section}-tapas w-full border rounded p-2" placeholder="Tapas" min="0">
    <button type="button" class="px-2 py-1 bg-gray-200 rounded" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  return div;
}

formContainer.innerHTML = `
  <h2 class="section-title mt-4">ProducciÃ³n</h2>
  <div id="produccion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-green-600 text-white rounded" onclick="addRow('produccion')">AÃ±adir otra producciÃ³n</button>

  <h2 class="section-title mt-4">ReparaciÃ³n</h2>
  <div id="reparacion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-orange-600 text-white rounded" onclick="addRow('reparacion')">AÃ±adir otra reparaciÃ³n</button>

  <h2 class="section-title mt-4">Mermas</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <input type="number" class="mermas-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="mermas-maderas w-full border rounded p-2" placeholder="Maderas" min="0">
    <input type="number" class="mermas-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="mermas-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="mermas-alto w-full border rounded p-2" placeholder="Alto">
  </div>

  <h2 class="section-title mt-4">RecuperaciÃ³n</h2>
  <select id="recuperacion-tipo" class="w-full border rounded p-2 mb-2">
    <option value="retestado">Retestado</option>
    <option value="otros">Otros</option>
  </select>
  <div id="recuperacion-detalles" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
    <input type="number" class="rec-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="rec-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="rec-alto w-full border rounded p-2" placeholder="Alto">
    <input type="number" class="rec-cantidad w-full border rounded p-2" placeholder="Cantidad">
  </div>

  <h2 class="section-title mt-4">Incidencias</h2>
  <textarea class="inc-mantenimiento w-full border rounded p-2 mb-2" rows="3" placeholder="Incidencias mantenimiento"></textarea>
  <textarea class="inc-produccion w-full border rounded p-2" rows="3" placeholder="Incidencias producciÃ³n"></textarea>
`;

addRow('produccion');
addRow('reparacion');

// Funciones
function addRow(section){
  const container = document.getElementById(section+'-container');
  container.appendChild(createRow(section));
}

document.getElementById('recuperacion-tipo').addEventListener('change', ()=>{
  document.getElementById('recuperacion-detalles').style.display = 'grid';
});

async function submitReport(){
  const produccion = Array.from(document.querySelectorAll('#produccion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.produccion-modelo').value,
    palets: parseInt(r.querySelector('.produccion-palets').value||0),
    tapas: parseInt(r.querySelector('.produccion-tapas').value||0)
  }));

  const reparacion = Array.from(document.querySelectorAll('#reparacion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.reparacion-modelo').value,
    palets: parseInt(r.querySelector('.reparacion-palets').value||0),
    tapas: parseInt(r.querySelector('.reparacion-tapas').value||0)
  }));

  const report = {
    lider: OPERATOR_NAME,
    userId,
    produccion,
    reparacion,
    mermas: {
      palets: parseInt(document.querySelector('.mermas-palets').value||0),
      maderas: parseInt(document.querySelector('.mermas-maderas').value||0),
      largo: parseInt(document.querySelector('.mermas-largo').value||0),
      ancho: parseInt(document.querySelector('.mermas-ancho').value||0),
      alto: parseInt(document.querySelector('.mermas-alto').value||0)
    },
    recuperacion: {
      tipo: document.getElementById('recuperacion-tipo').value,
      largo: parseInt(document.querySelector('.rec-largo').value||0),
      ancho: parseInt(document.querySelector('.rec-ancho').value||0),
      alto: parseInt(document.querySelector('.rec-alto').value||0),
      cantidad: parseInt(document.querySelector('.rec-cantidad').value||0)
    },
    incidencias: {
      mantenimiento: document.querySelector('.inc-mantenimiento').value,
      produccion: document.querySelector('.inc-produccion').value
    },
    fecha: new Date().toISOString()
  };

  try{
    const resp = await fetch('/api/reportes', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(report)
    });
    if(resp.ok){
      alert('âœ… Reporte enviado correctamente');
      document.querySelectorAll('input, textarea').forEach(i=>i.value='');
      document.getElementById('produccion-container').innerHTML='';
      document.getElementById('reparacion-container').innerHTML='';
      addRow('produccion');
      addRow('reparacion');
    } else {
      const json = await resp.json();
      alert('Error al enviar: ' + (json.error||''));
    }
  } catch(err){
    console.error(err);
    alert('Error al enviar el reporte');
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Francisco Javier Herrera (251)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco Javier Herrera";
  const OPERATOR_CODE = "251";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_251";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Francisco QuiÃ±ones (199)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco QuiÃ±ones";
  const OPERATOR_CODE = "199";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_199";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Francisco Romero (239)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco Romero";
  const OPERATOR_CODE = "239";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_239";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Humberto Mariscal (177)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Humberto Mariscal";
  const OPERATOR_CODE = "177";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_177";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Turno - LÃ­der</title>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<style>
  body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
  .action-button{ transition:.12s }
  .logo { width:40px; height:40px }
  .section-title { font-weight:600; color:#1F4E79 } /* azul corporativo */
  .submit-button { background:#1F4E79; color:white }
  .submit-button:hover { background:#163955 }
</style>
</head>
<body class="p-4">
<div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
  <header class="mb-4 flex items-center">
    <img src="images/logo.png" alt="Logo" width="40" height="40" class="inline-block mr-2">
    <h1 class="text-2xl font-bold">Registro de Turno - LÃ­der</h1>
  </header>

  <div>Usuario: <span id="operator-name">Jonatan Escarraman (178)</span></div>

  <div id="form-container"></div>

  <div class="mt-4">
    <button onclick="submitReport()" class="submit-button px-4 py-2 rounded font-semibold">Enviar Reporte</button>
  </div>
</div>

<script>
const OPERATOR_NAME = "Jonatan Escarraman";
const OPERATOR_CODE = "178";
let userId = "user_178";

const formContainer = document.getElementById('form-container');

// FunciÃ³n para crear una fila de producciÃ³n/reparaciÃ³n con Palets y Tapas fijos
function createRow(section){
  const div = document.createElement('div');
  div.className = "grid grid-cols-1 md:grid-cols-4 gap-4 mt-2 row-entry";

  div.innerHTML = `
    <select class="${section}-modelo w-full border rounded p-2">
      <option>CHEP 1210</option>
      <option>CHEP 1208</option>
      <option>IPP 1208</option>
      <option>IPP 1210</option>
      <option>PR80</option>
      <option>UK 100</option>
      <option>AZ 80</option>
      <option>AZ 100</option>
      <option>EUR-UIC</option>
      <option>OTROS</option>
    </select>
    <input type="number" class="${section}-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="${section}-tapas w-full border rounded p-2" placeholder="Tapas" min="0">
    <button type="button" class="px-2 py-1 bg-gray-200 rounded" onclick="this.parentNode.remove()">Eliminar</button>
  `;
  return div;
}

formContainer.innerHTML = `
  <h2 class="section-title mt-4">ProducciÃ³n</h2>
  <div id="produccion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-green-600 text-white rounded" onclick="addRow('produccion')">AÃ±adir otra producciÃ³n</button>

  <h2 class="section-title mt-4">ReparaciÃ³n</h2>
  <div id="reparacion-container"></div>
  <button type="button" class="mt-2 px-3 py-1 bg-orange-600 text-white rounded" onclick="addRow('reparacion')">AÃ±adir otra reparaciÃ³n</button>

  <h2 class="section-title mt-4">Mermas</h2>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <input type="number" class="mermas-palets w-full border rounded p-2" placeholder="Palets" min="0">
    <input type="number" class="mermas-maderas w-full border rounded p-2" placeholder="Maderas" min="0">
    <input type="number" class="mermas-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="mermas-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="mermas-alto w-full border rounded p-2" placeholder="Alto">
  </div>

  <h2 class="section-title mt-4">RecuperaciÃ³n</h2>
  <select id="recuperacion-tipo" class="w-full border rounded p-2 mb-2">
    <option value="retestado">Retestado</option>
    <option value="otros">Otros</option>
  </select>
  <div id="recuperacion-detalles" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2">
    <input type="number" class="rec-largo w-full border rounded p-2" placeholder="Largo">
    <input type="number" class="rec-ancho w-full border rounded p-2" placeholder="Ancho">
    <input type="number" class="rec-alto w-full border rounded p-2" placeholder="Alto">
    <input type="number" class="rec-cantidad w-full border rounded p-2" placeholder="Cantidad">
  </div>

  <h2 class="section-title mt-4">Incidencias</h2>
  <textarea class="inc-mantenimiento w-full border rounded p-2 mb-2" rows="3" placeholder="Incidencias mantenimiento"></textarea>
  <textarea class="inc-produccion w-full border rounded p-2" rows="3" placeholder="Incidencias producciÃ³n"></textarea>
`;

addRow('produccion');
addRow('reparacion');

// Funciones
function addRow(section){
  const container = document.getElementById(section+'-container');
  container.appendChild(createRow(section));
}

document.getElementById('recuperacion-tipo').addEventListener('change', ()=>{
  document.getElementById('recuperacion-detalles').style.display = 'grid';
});

async function submitReport(){
  const produccion = Array.from(document.querySelectorAll('#produccion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.produccion-modelo').value,
    palets: parseInt(r.querySelector('.produccion-palets').value||0),
    tapas: parseInt(r.querySelector('.produccion-tapas').value||0)
  }));

  const reparacion = Array.from(document.querySelectorAll('#reparacion-container .row-entry')).map(r=>({
    modelo: r.querySelector('.reparacion-modelo').value,
    palets: parseInt(r.querySelector('.reparacion-palets').value||0),
    tapas: parseInt(r.querySelector('.reparacion-tapas').value||0)
  }));

  const report = {
    lider: OPERATOR_NAME,
    userId,
    produccion,
    reparacion,
    mermas: {
      palets: parseInt(document.querySelector('.mermas-palets').value||0),
      maderas: parseInt(document.querySelector('.mermas-maderas').value||0),
      largo: parseInt(document.querySelector('.mermas-largo').value||0),
      ancho: parseInt(document.querySelector('.mermas-ancho').value||0),
      alto: parseInt(document.querySelector('.mermas-alto').value||0)
    },
    recuperacion: {
      tipo: document.getElementById('recuperacion-tipo').value,
      largo: parseInt(document.querySelector('.rec-largo').value||0),
      ancho: parseInt(document.querySelector('.rec-ancho').value||0),
      alto: parseInt(document.querySelector('.rec-alto').value||0),
      cantidad: parseInt(document.querySelector('.rec-cantidad').value||0)
    },
    incidencias: {
      mantenimiento: document.querySelector('.inc-mantenimiento').value,
      produccion: document.querySelector('.inc-produccion').value
    },
    fecha: new Date().toISOString()
  };

  try{
    const resp = await fetch('/api/reportes', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(report)
    });
    if(resp.ok){
      alert('âœ… Reporte enviado correctamente');
      document.querySelectorAll('input, textarea').forEach(i=>i.value='');
      document.getElementById('produccion-container').innerHTML='';
      document.getElementById('reparacion-container').innerHTML='';
      addRow('produccion');
      addRow('reparacion');
    } else {
      const json = await resp.json();
      alert('Error al enviar: ' + (json.error||''));
    }
  } catch(err){
    console.error(err);
    alert('Error al enviar el reporte');
  }
}
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Jose Gregorio Sarti (196)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Jose Gregorio Sarti";
  const OPERATOR_CODE = "196";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_196";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">JosÃ© PÃ©rez (252)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "JosÃ© PÃ©rez";
  const OPERATOR_CODE = "252";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_252";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Josue Cortes (246)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Josue Cortes";
  const OPERATOR_CODE = "246";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_246";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Juan Carlos Ugueto (204)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Carlos Ugueto";
  const OPERATOR_CODE = "204";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_204";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Juan Jose Sarti (203)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Jose Sarti";
  const OPERATOR_CODE = "203";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_203";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name">Juan Manuel Baez (244)</span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Manuel Baez";
  const OPERATOR_CODE = "244";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_244";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Angel Luis Torres";
  const OPERATOR_CODE = "250";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_250";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Antonio Ramos";
  const OPERATOR_CODE = "243";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_243";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    
      <section class="mb-4 bg-blue-50 p-4 rounded">
        <h2 class="font-semibold">Pallets producidos</h2>
        <input id="pallets-input" type="number" class="mt-2 w-full border p-2 rounded" placeholder="Introduce total del dÃ­a">
      </section>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Antonio Montes";
  const OPERATOR_CODE = "120";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_120";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Carlos Javier Rivera";
  const OPERATOR_CODE = "158";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_158";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Eloy QuiÃ±ones";
  const OPERATOR_CODE = "40";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_40";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    
      <section class="mb-4 bg-blue-50 p-4 rounded">
        <h2 class="font-semibold">Pallets producidos</h2>
        <input id="pallets-input" type="number" class="mt-2 w-full border p-2 rounded" placeholder="Introduce total del dÃ­a">
      </section>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco Garcia";
  const OPERATOR_CODE = "229";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_229";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco Javier Herrera";
  const OPERATOR_CODE = "251";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_251";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco QuiÃ±ones";
  const OPERATOR_CODE = "199";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_199";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Francisco Romero";
  const OPERATOR_CODE = "239";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_239";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Humberto Mariscal";
  const OPERATOR_CODE = "177";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_177";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    
      <section class="mb-4 bg-blue-50 p-4 rounded">
        <h2 class="font-semibold">Pallets producidos</h2>
        <input id="pallets-input" type="number" class="mt-2 w-full border p-2 rounded" placeholder="Introduce total del dÃ­a">
      </section>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Jonatan Escarraman";
  const OPERATOR_CODE = "178";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_178";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Jose Gregorio Sarti";
  const OPERATOR_CODE = "196";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_196";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "JosÃ© PÃ©rez";
  const OPERATOR_CODE = "252";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_252";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Josue Cortes";
  const OPERATOR_CODE = "246";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_246";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Carlos Ugueto";
  const OPERATOR_CODE = "204";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_204";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Jose Sarti";
  const OPERATOR_CODE = "203";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_203";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Turno - Reporte</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f3f4f6 }
    .action-button{ transition:.12s }
  </style>
</head>
<body class="p-4">
  <div class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow">
    <header class="mb-4">
      <h1 class="text-2xl font-bold">Registro de Turno</h1>
      <div class="mt-2 text-sm text-gray-600">Usuario: <span id="operator-name"></span></div>
      <div class="mt-1 text-xs text-gray-500">Estado: <span id="user-id">Inicializando...</span></div>
    </header>

    <section class="mb-4 bg-green-50 p-4 rounded">
      <h2 class="font-semibold">Actividad actual</h2>
      <p id="current-activity-name" class="font-bold">Ninguna actividad en curso</p>
      <div id="timer-box" class="text-3xl font-bold mt-2">00:00:00</div>
      <button id="stop-button" class="mt-3 px-4 py-2 bg-red-600 text-white rounded hidden" onclick="promptForComment('stop')">FINALIZAR Y REGISTRAR</button>
    </section>

    <section class="mb-4">
      <h2 class="font-semibold">Iniciar actividad</h2>
      <div id="activity-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3"></div>
    </section>

    <section>
      <div class="flex justify-between items-center mb-2">
        <h2 class="font-semibold">Historial</h2>
        <div>
          <button id="report-button" class="px-3 py-1 bg-blue-600 text-white rounded" onclick="generateReportAndSend()">ðŸ“¤ Mandar Reporte</button>
          <button id="delete-button" class="px-3 py-1 ml-2 bg-gray-200 rounded" onclick="clearAllData()">ðŸ—‘ï¸ Borrar todo</button>
        </div>
      </div>
      <div id="history-list" class="space-y-2"></div>
      <p id="empty-history-message" class="text-gray-500">No hay registros guardados.</p>
    </section>
  </div>

  <!-- Modal Comentario -->
  <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded max-w-md w-11/12">
      <h3 id="comment-modal-title" class="font-bold mb-2">Comentario</h3>
      <textarea id="comment-input" rows="4" class="w-full border p-2 rounded" placeholder="Comentario..."></textarea>
      <div class="mt-3 flex justify-end space-x-2">
        <button onclick="closeCommentModal(true)" class="px-3 py-1 bg-gray-200 rounded">Omitir</button>
        <button onclick="closeCommentModal(false)" class="px-3 py-1 bg-green-600 text-white rounded">Guardar</button>
      </div>
      <input type="hidden" id="modal-action-type">
      <input type="hidden" id="modal-activity-type">
    </div>
  </div>

<script>
  const OPERATOR_NAME = "Juan Manuel Baez";
  const OPERATOR_CODE = "244";
  const REPORT_FUNCTION_URL = "/api/sendReport";
  const REPORT_RECIPIENT = "borjadiazcabezas@gmail.com";

  document.getElementById('operator-name').textContent = `${OPERATOR_NAME} (${OPERATOR_CODE})`;

  const activityTypes = [
    { type: 'Produccion', color: 'bg-green-600' },
    { type: 'Limpieza', color: 'bg-yellow-600' },
    { type: 'Averia', color: 'bg-red-600' },
    { type: 'Mantenimiento', color: 'bg-blue-600' },
    { type: 'Arreglo Palets', color: 'bg-purple-600' },
    { type: 'Cambio', color: 'bg-orange-600' },
    { type: 'OTROS', color: 'bg-gray-600' }
  ];

  const pad = n => String(n).padStart(2,'0');
  const formatDuration = ms => {
    if (!ms || ms < 0) return '00:00:00';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  };

  let userId = "user_244";
  let currentActivity = null;
  let timerInterval = null;
  let activitiesHistory = [];

  const updateTimerDisplay = () => {
    if(currentActivity && currentActivity.startTime) {
      const startMs = currentActivity.startTime;
      document.getElementById('timer-box').textContent = formatDuration(Date.now() - startMs);
    } else {
      document.getElementById('timer-box').textContent = '00:00:00';
    }
  };

  const renderActivityButtons = () => {
    const container = document.getElementById('activity-buttons');
    container.innerHTML = '';
    activityTypes.forEach(a => {
      const btn = document.createElement('button');
      btn.className = `action-button p-3 rounded text-white font-bold ${a.color}`;
      btn.textContent = a.type;
      btn.onclick = () => {
        if(currentActivity) {
          if(currentActivity.name === a.type) return promptForComment('stop');
          stopActivity().then(()=>promptForComment('start', a.type));
        } else {
          promptForComment('start', a.type);
        }
      };
      container.appendChild(btn);
    });
  };

  const updateUIState = () => {
    const nameEl = document.getElementById('current-activity-name');
    const stopBtn = document.getElementById('stop-button');
    if(currentActivity) {
      nameEl.textContent = currentActivity.name;
      stopBtn.classList.remove('hidden');
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplay, 1000);
    } else {
      nameEl.textContent = 'Ninguna actividad en curso';
      stopBtn.classList.add('hidden');
      if(timerInterval) clearInterval(timerInterval);
    }
    updateTimerDisplay();
    renderHistory();
  };

  async function startActivity(activityType, comment='') {
    const startTime = Date.now();
    currentActivity = { name: activityType, startTime, startComment: comment };
    updateUIState();
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ operario: OPERATOR_NAME, activityType, startTime, startComment: comment })
      });
    } catch(err) { console.error(err); }
  }

  async function stopActivity(comment='') {
    if(!currentActivity) return;
    const endTime = Date.now();
    const durationMs = endTime - currentActivity.startTime;
    const activityRecord = {
      operario: OPERATOR_NAME,
      activityType: currentActivity.name,
      startTime: currentActivity.startTime,
      endTime,
      durationMs,
      startComment: currentActivity.startComment || null,
      endComment: comment || null
    };
    activitiesHistory.unshift(activityRecord);
    updateUIState();
    currentActivity = null;
    try {
      await fetch('/api/reportes', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(activityRecord)
      });
    } catch(err){ console.error(err); }
  }

  const renderHistory = () => {
    const container = document.getElementById('history-list');
    container.innerHTML = '';
    if(!activitiesHistory.length) {
      document.getElementById('empty-history-message').classList.remove('hidden');
      return;
    }
    document.getElementById('empty-history-message').classList.add('hidden');
    activitiesHistory.forEach(item => {
      const div = document.createElement('div');
      div.className = 'p-3 border rounded bg-white shadow';
      const start = new Date(item.startTime).toLocaleString('es-ES');
      const end = item.endTime ? new Date(item.endTime).toLocaleString('es-ES') : 'N/A';
      div.innerHTML = `<strong>${item.activityType}</strong>
                       <div class="text-sm">Inicio: ${start} â€” Fin: ${end} â€” DuraciÃ³n: <strong>${formatDuration(item.durationMs)}</strong></div>
                       ${item.startComment ? `<div class="text-xs mt-1 p-1 bg-indigo-50 rounded">Inicio: ${item.startComment}</div>` : ''}
                       ${item.endComment ? `<div class="text-xs mt-1 p-1 bg-yellow-50 rounded">Fin: ${item.endComment}</div>` : ''}`;
      container.appendChild(div);
    });
  };

  window.promptForComment = (action, activityType=null)=>{
    document.getElementById('comment-input').value='';
    document.getElementById('modal-action-type').value = action;
    document.getElementById('modal-activity-type').value = activityType || (currentActivity?currentActivity.name:'');
    document.getElementById('comment-modal-title').textContent = action==='start' ? `Comentario de Inicio: ${activityType}` : `Comentario de FinalizaciÃ³n: ${currentActivity ? currentActivity.name : ''}`;
    document.getElementById('comment-modal').classList.remove('hidden');
  };

  window.closeCommentModal = (omit)=>{
    const comment = omit ? '' : document.getElementById('comment-input').value.trim();
    const action = document.getElementById('modal-action-type').value;
    const activityType = document.getElementById('modal-activity-type').value;
    document.getElementById('comment-modal').classList.add('hidden');
    if(action==='start') startActivity(activityType, comment);
    else stopActivity(comment);
  };

  async function clearAllData(){
    if(!confirm("Confirmar borrado de TODO el historial de este usuario?")) return;
    activitiesHistory = [];
    currentActivity=null;
    updateUIState();
    try {
      await fetch('/api/reportes/clear', { method:'POST' });
    } catch(err){ console.error(err); }
  }

  async function generateReportAndSend(){
    if(!activitiesHistory.length) return alert("No hay datos para enviar.");
    const rows = activitiesHistory.map(a=>{
      const start = new Date(a.startTime).toLocaleString('es-ES');
      const end = a.endTime ? new Date(a.endTime).toLocaleString('es-ES') : 'N/A';
      const duration = formatDuration(a.durationMs);
      return `<tr>
        <td style="padding:8px;border:1px solid #ddd">${a.activityType}</td>
        <td style="padding:8px;border:1px solid #ddd">${start}</td>
        <td style="padding:8px;border:1px solid #ddd">${end}</td>
        <td style="padding:8px;border:1px solid #ddd">${duration}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.startComment || '-'}</td>
        <td style="padding:8px;border:1px solid #ddd">${a.endComment || '-'}</td>
      </tr>`;
    }).join('');

    const htmlBody = `
      <h2>Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})</h2>
      <table style="border-collapse:collapse;width:100%;font-family:Arial,Helvetica,sans-serif">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Actividad</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Fin</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">DuraciÃ³n</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario inicio</th>
            <th style="padding:8px;border:1px solid #ddd;background:#f3f4f6">Comentario fin</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    const subject = `Reporte diario â€“ ${OPERATOR_NAME} (${OPERATOR_CODE})`;

    try {
      const resp = await fetch(REPORT_FUNCTION_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({subject,recipient:REPORT_RECIPIENT,html:htmlBody,text:`Reporte generado por ${OPERATOR_NAME}`})
      });
      if(resp.ok){
        alert("âœ… Reporte enviado correctamente.");
        if(confirm("Â¿Deseas borrar todos los registros del dÃ­a?")) clearAllData();
      } else {
        const json = await resp.json();
        console.error("Error:", json);
        alert("Error al enviar el reporte");
      }
    } catch(err){ console.error(err); alert("Error al enviar el reporte"); }
  }

  function initApp(){
    renderActivityButtons();
    updateUIState();
  }

  window.onload = initApp;
</script>
</body>
</html>

